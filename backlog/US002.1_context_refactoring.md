## User Story: Context Object Refactoring for Plugin Abstraction (Granular Services)

**As a:** Plugin Developer
**I want to:** Have a clean and comprehensive `Context` object that abstracts common application functionalities
**So that:** I can focus purely on implementing game rule logic and prompts within my plugin, without worrying about underlying UI updates, backend call mechanisms, or state management.

### Discussion: Centralizing Application Functionalities in Context with Granular Services

This approach refines the `Context` object (`app/plugins.ts`) to serve as the primary interface between plugins and the core application. By providing abstracted methods through granular service objects, plugins become cleaner, more reusable, and easier to develop, while minimizing merge conflicts with upstream `HEAD`.

**Evolution of `Context` and the Need for Granular Services:**

The original `Context` object (as per the true root version) was very minimalist, primarily providing `pluginName`, `saveSettings`, and `addBackendUI`. Over time, due to pragmatic development needs, `Context` expanded significantly to include direct access to core libraries (React, Immer, Radix Themes, etc.), global state management, backend access, and progress reporting. This evolution, while functional, led to `Context` becoming a "de facto service locator" with mixed responsibilities.

The introduction of **granular service objects** (e.g., `AppLibs`, `AppBackend`, `AppStateManager`, `AppUI`) aims to bring architectural clarity to this expanded `Context`. It formalizes and organizes the responsibilities that `Context` has accumulated, while preserving the original `Context` methods as-is to minimize merge conflicts with upstream `HEAD`. This approach avoids the "God Object" anti-pattern for `CoreAppServices` by breaking it down into focused, single-responsibility APIs.

*   **Mechanism:**
    1.  **Define and Implement Granular Service Objects:**
        *   Instead of a single `CoreAppServices` class, multiple focused service classes will be created (e.g., `AppLibs`, `AppBackend`, `AppStateManager`, `AppUI`).
        *   **`AppLibs`:** Encapsulates direct library references (`react`, `immer`, `radixThemes`, `reactIconsGi`, `useShallow`, `rpgDiceRoller`).
        *   **`AppBackend`:** Encapsulates backend access (`getBackend`), and new abstracted backend calls (`getNarration`, `getObject`, `abort`, `isAbortError`).
        *   **`AppStateManager`:** Encapsulates global state management (`setGlobalState`, `getGlobalState`), and local settings management (`setPluginSelected`).
        *   **`AppUI`:** Encapsulates UI-related functionalities (`updateProgress`, `addCharacterUI`, `addBackendUI`, `showError`, `log`).
        *   Each service object's constructor will receive its specific dependencies.
    2.  **Modify `lib/backend.ts`:**
        *   Change `getNarration` and `getObject` method signatures to accept a high-level `onProgress` callback (`(title: string, message: string, tokenCount?: number, visible?: boolean) => void`).
        *   Inside these methods, adapt the low-level `onToken` callback from `getResponse` to call the new `onProgress` callback with appropriate default titles, messages, and visibility states. This makes the backend directly responsible for reporting its own progress in a UI-friendly manner.
    3.  **Refactor `Context` (`app/plugins.ts`):**
        *   `Context` will be stripped down to its root version's responsibilities, making it a gateway to these granular service objects.
        *   Its constructor will primarily take `pluginName` and instances of the granular service objects (e.g., `appLibs`, `appBackend`, `appStateManager`, `appUI`).
        *   All properties and methods that are now part of these granular services will be removed from `Context`.
        *   New properties will be added to `Context` to hold instances of these granular services (e.g., `appLibs: AppLibs;`, `appBackend: AppBackend;`, etc.).
        *   Original `Context` methods (`saveSettings`, `addBackendUI`) will be preserved as-is on the `Context` object. Their implementation will be modified to use `this.<granularService>.getGlobalState()` or `this.<granularService>.getPluginsState().set(...)` for underlying dependencies.
    4.  **Modify `lib/engine.ts`:**
        *   Remove the `onToken` throttled adapter.
        *   Pass the `onProgress` callback directly to `backend.getNarration` and `backend.getObject` calls. This simplifies `lib/engine.engine`'s role in progress reporting.
    5.  **Update `app/page.tsx`:**
        *   Instantiate each granular service object with its required dependencies.
        *   Pass these instantiated service objects to the `Context` constructor when loading plugins.
    6.  **Refactor Plugins (e.g., `plugins/game-rule-dnd5e/src/main.tsx`):**
        *   Replace direct calls to `this.context!.getBackend().getNarration` with `this.context!.appBackend.getNarration`.
        *   All other functionalities (global state, direct library references, UI registration, local settings management) will be accessed via `this.context!.<granularService>`.
        *   Manual `this.context!.updateProgress` calls around backend operations are removed.
        *   The plugin's code remains functional and type-safe after these changes.

*   **Pros:**
    *   **Minimizes Merge Conflicts:** By keeping `Context` close to its root version, future merges with upstream `HEAD` are less likely to conflict with changes to `Context`.
    *   **Cleaner Plugin Code:** Plugins become highly focused on game logic, with all boilerplate abstracted.
    *   **Improved Reusability:** Plugins are less coupled to core application internals, making them easier to reuse, test, and maintain. Changes to core services are isolated to their specific granular service objects.
    *   **Consistent User Experience:** Centralized progress reporting and error handling ensure consistency.
    *   **Architectural Clarity:** Formalizes the separation of concerns, making the application's structure easier to understand. Avoids the "God Object" anti-pattern.
    *   **Scalability:** Provides a robust and scalable foundation for adding more complex plugins and evolving core application functionalities.
    *   **Reduced Boilerplate:** Plugin developers write less repetitive code.

*   **Cons:**
    *   **Significant Refactoring Effort:** This is a more extensive refactoring than previously planned, touching many core files.
    *   **Increased Indirection:** Plugins will access functionalities via `this.context.<granularService>.someMethod()`, which is an extra dot. This is a minor readability trade-off for significant architectural benefits.
    *   **Initial Setup Complexity:** Requires careful orchestration of dependencies.

### Decision

We will implement this refactoring to centralize application functionalities within **granular service objects**, and refactor `Context` to align with its root version. This will involve modifying `lib/backend.ts`, `lib/engine.ts`, `app/plugins.ts`, and `app/page.tsx`, followed by refactoring existing plugin code (starting with `game-rule-dnd5e`) to utilize the new `Context` structure.

### Acceptance Criteria

*   **AC1: Backend Progress Reporting:**
    *   `lib/backend.ts`'s `getNarration` and `getObject` methods accept an `onProgress` callback (`(title, message, tokenCount, visible) => void`).
    *   When `getNarration` or `getObject` are called with an `onProgress` callback, they correctly report token generation progress (title, message, tokenCount) and visibility state (show/hide) to the provided callback.
*   **AC2: Engine Integration:**
    *   `lib/engine.ts` no longer uses its internal `onToken` throttled adapter for backend calls.
    *   `lib/engine.ts` passes its `onProgress` callback directly to `backend.getNarration` and `backend.getObject` calls.
*   **AC3: Granular Service Definitions:**
    *   New classes are defined for `AppLibs`, `AppBackend`, `AppStateManager`, and `AppUI`, encapsulating their respective functionalities as detailed in the "Mechanism" section.
*   **AC4: `Context` Refactoring:**
    *   The `Context` class in `app/plugins.ts` is refactored to align with its root version.
    *   It contains `pluginName`, and properties for each granular service (e.g., `appLibs: AppLibs;`, `appBackend: AppBackend;`, `appStateManager: AppStateManager;`, `appUI: AppUI;`).
    *   `saveSettings` and `addBackendUI` retain their original signatures and delegate to the appropriate granular service for underlying dependencies.
*   **AC5: Core Application Integration:**
    *   `app/page.tsx` correctly instantiates each granular service object with its dependencies.
    *   `app/page.tsx` passes these instantiated service objects to the `Context` constructor.
*   **AC6: Plugin Refactoring (`game-rule-dnd5e`):
    *   `plugins/game-rule-dnd5e/src/main.tsx` replaces direct calls to `this.context!.getBackend().getNarration` with `this.context!.appBackend.getNarration`.
    *   All other functionalities (global state, direct library references, UI registration, local settings management) are accessed via `this.context!.<granularService>`.
    *   Manual `this.context!.updateProgress` calls around backend operations are removed.
    *   The plugin's code remains functional and type-safe after these changes.
*   **AC7: Runtime Verification:**
    *   The `ProcessingOverlay` correctly appears with appropriate titles and messages, displays token count, and disappears automatically when backend operations (e.g., backstory generation) are initiated and completed via the new granular service methods.
    *   The cancel button functionality remains intact and correctly aborts backend operations, hiding the overlay.
    *   All other application functionalities (state management, UI registration) work as expected.
