# Technical Specification

This is the technical specification for the spec detailed in @.agent-os/specs/2025-07-24-dnd-5e-stats-skills-plugin/spec.md

> Created: 2025-07-24
> Version: 1.0.0

## Technical Requirements

-   **Schema Extension**: Extend the `Character` schema in `lib/schemas.ts` to include:
    -   `abilityScores`: An object containing `strength`, `dexterity`, `constitution`, `intelligence`, `wisdom`, `charisma` (integer, min 1, max 30).
    -   `skills`: An object containing all 18 D&D 5e skills (e.g., `acrobatics`, `athletics`, `deception`, etc.) with integer values (min 0, max 20).
    -   `hp`: Current hit points (integer, min 0).
    -   `maxHp`: Maximum hit points (integer, min 1).
    -   `armorClass`: Armor Class (integer, min 0).
-   **Plugin Hook Definition**: Define new hooks within the `Plugin` interface in `lib/state.ts`:
    -   `onCharacterCreation(character: WritableDraft<Character>, state: WritableDraft<State>): Promise<void>`: To allow plugins to inject D&D 5e specific attributes during character generation.
    -   `onAbilityCheck(characterIndex: number, ability: keyof AbilityScores, skill?: keyof Skills, DC?: number): Promise<{ roll: number; modifier: number; total: number; success: boolean; critical: 'none' | 'success' | 'failure' } | null>`: To enable plugins to handle ability and skill checks.
-   **D&D 5e Plugin Implementation**: Create a new plugin at `plugins/dnd5e-plugin/index.ts` that:
    -   Implements the `onCharacterCreation` hook to generate and assign D&D 5e ability scores, skills, HP, Max HP, and Armor Class to new characters. This will involve prompting the LLM for these values.
    -   Registers itself in the system.
-   **Engine Integration**: Modify `lib/engine.ts` to:
    -   Call the `onCharacterCreation` plugin hook after the protagonist and other characters are generated by the LLM.
    -   Introduce a new `performAbilityCheck` function that iterates through enabled plugins and calls their `onAbilityCheck` hook. If no plugin handles the check, it will fall back to a default implementation (to be defined in a later phase).
-   **Prompt Engineering**: Update `lib/prompts.ts` to:
    -   Modify `generateProtagonistPrompt` and `generateStartingCharactersPrompt` to explicitly instruct the LLM to generate D&D 5e ability scores and skills in a structured format (e.g., JSON) that can be parsed by the plugin.
-   **UI Display**: Update `components/CharacterView.tsx` to display the new D&D 5e attributes (ability scores, skills, HP, Max HP, Armor Class) for the protagonist and other characters.

## Approach Options

**Option A: Direct Core File Modification (Rejected)**
-   **Description:** Directly embed D&D 5e specific logic and data structures within `lib/schemas.ts`, `lib/engine.ts`, and `lib/state.ts` without using the plugin system for this feature.
-   **Pros:** Potentially faster initial implementation for a single rule set.
-   **Cons:** Violates modularity, makes it difficult to support multiple RPG rule systems in the future, clutters core files with specific game logic.

**Option B: Plugin-Based Implementation (Selected)**
-   **Description:** Leverage the existing plugin architecture by defining new hooks in `lib/state.ts` and implementing the D&D 5e specific logic within a dedicated plugin (`plugins/dnd5e-plugin`). Core `lib` files will only be modified to expose these hooks and call them at appropriate points.
-   **Pros:** Promotes modularity and extensibility, allows for easy addition of other RPG rule systems, keeps core logic clean, aligns with the project's stated plugin-based architecture.
-   **Cons:** Requires initial setup of new hooks and plugin structure, slightly more complex initial implementation compared to direct modification.

**Rationale:** Option B is selected as it aligns with the project's architectural vision of a plugin-based system. This approach ensures that the core engine remains flexible and can accommodate various RPG rule sets in the future without significant refactoring. It promotes clean code separation and maintainability.

## External Dependencies

-   No new external dependencies are anticipated for this phase. Existing libraries like `zod` will be used for schema validation and `immer` for state management within the plugin context.